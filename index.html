<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“ä¸šä¸‡èƒ½æ°´å°å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .sidebar {
            background: #f8fafc;
            padding: 30px;
            overflow-y: auto;
            max-height: 85vh;
        }

        .preview-area {
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 500px;
            background: #fafbfc;
            position: relative;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 5px;
            color: #4b5563;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .form-range {
            width: 100%;
            margin: 10px 0;
        }

        .range-value {
            font-size: 0.8rem;
            color: #6b7280;
            text-align: center;
        }

        .color-input {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .btn.active:hover {
            background: #5a67d8;
        }

        .upload-area {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .preview-container {
            position: relative;
            max-width: 100%;
            max-height: 60vh;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .preview-image {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            display: block;
        }

        .watermark-overlay {
            position: absolute;
            font-family: inherit;
            white-space: nowrap;
            cursor: move;
            user-select: none;
            transform-origin: center center;
        }

        .watermark-overlay.dragging {
            z-index: 1000;
        }

        .watermark-overlay:hover {
            outline: 2px dashed rgba(102, 126, 234, 0.5);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .control-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .control-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .control-btn.secondary:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .grid-cols-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .grid-cols-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .text-center { text-align: center; }

        /* æ‰¹é‡å¤„ç†é¢æ¿ */
        .batch-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .batch-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .batch-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .batch-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .batch-item:last-child {
            border-bottom: none;
        }

        .batch-progress {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .batch-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* é¢„è®¾æ¨¡æ¿ */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .preset-item {
            padding: 15px 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .preset-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .preset-item.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .preset-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .preset-name {
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* å›¾ç‰‡æ°´å°ä¸Šä¼  */
        .image-watermark-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            margin-bottom: 15px;
        }

        .image-watermark-upload:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .watermark-image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 6px;
            margin: 10px auto;
            display: block;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 0;
            }

            .sidebar {
                max-height: none;
                padding: 20px;
            }

            .preview-area {
                padding: 20px;
                min-height: 300px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-btn {
                text-align: center;
                justify-content: center;
            }

            .grid-cols-2,
            .grid-cols-3 {
                grid-template-columns: 1fr;
            }

            .preset-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .batch-content {
                width: 95%;
                padding: 20px;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .preview-container {
            animation: fadeIn 0.5s ease;
        }

        .processing {
            animation: pulse 1s infinite;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .sidebar::-webkit-scrollbar,
        .batch-list::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track,
        .batch-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb,
        .batch-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover,
        .batch-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* æ°´å°æ‹–æ‹½æŒ‡ç¤ºå™¨ */
        .drag-indicator {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            bottom: -4px;
            right: -4px;
            cursor: move;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ ä¸“ä¸šä¸‡èƒ½æ°´å°å·¥å…·</h1>
            <p>æ”¯æŒHEICæ ¼å¼ã€æ‰¹é‡å¤„ç†ã€æ‹–æ‹½è°ƒæ•´çš„ä¸“ä¸šæ°´å°è§£å†³æ–¹æ¡ˆ</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <!-- å›¾ç‰‡ä¸Šä¼  -->
                <div class="section">
                    <div class="section-title">ğŸ“¸ å›¾ç‰‡ä¸Šä¼ </div>
                    <div class="upload-area" id="uploadArea">
                        <div style="font-size: 3rem; margin-bottom: 15px; color: #9ca3af;">ğŸ“</div>
                        <p style="font-size: 1.1rem; font-weight: 500; margin-bottom: 8px;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</p>
                        <p style="font-size: 0.9rem; color: #6b7280;">æ”¯æŒ JPGã€PNGã€GIFã€WebPã€HEIC æ ¼å¼</p>
                        <input type="file" id="imageInput" accept="image/*,.heic" multiple style="display: none;">
                    </div>
                    <div class="controls" style="margin-top: 15px; justify-content: flex-start;">
                        <button class="control-btn secondary" onclick="openBatchPanel()">
                            ğŸ“¦ æ‰¹é‡å¤„ç†
                        </button>
                    </div>
                </div>

                <!-- é¢„è®¾æ¨¡æ¿ -->
                <div class="section">
                    <div class="section-title">ğŸ¯ é¢„è®¾æ¨¡æ¿</div>
                    <div class="preset-grid">
                        <div class="preset-item" data-preset="copyright">
                            <div class="preset-icon">Â©</div>
                            <div class="preset-name">ç‰ˆæƒæ°´å°</div>
                        </div>
                        <div class="preset-item" data-preset="confidential">
                            <div class="preset-icon">ğŸ”’</div>
                            <div class="preset-name">æœºå¯†æ–‡ä»¶</div>
                        </div>
                        <div class="preset-item" data-preset="draft">
                            <div class="preset-icon">ğŸ“</div>
                            <div class="preset-name">è‰ç¨¿æ ‡è®°</div>
                        </div>
                        <div class="preset-item" data-preset="brand">
                            <div class="preset-icon">ğŸ·ï¸</div>
                            <div class="preset-name">å“ç‰Œæ ‡è¯†</div>
                        </div>
                        <div class="preset-item" data-preset="photographer">
                            <div class="preset-icon">ğŸ“·</div>
                            <div class="preset-name">æ‘„å½±å¸ˆ</div>
                        </div>
                        <div class="preset-item" data-preset="sample">
                            <div class="preset-icon">ğŸ”</div>
                            <div class="preset-name">æ ·æœ¬æ ‡è®°</div>
                        </div>
                    </div>
                </div>

                <!-- æ°´å°ç±»å‹ -->
                <div class="section">
                    <div class="section-title">ğŸ·ï¸ æ°´å°ç±»å‹</div>
                    <div class="button-group">
                        <button class="btn active" data-type="text">æ–‡å­—æ°´å°</button>
                        <button class="btn" data-type="image">å›¾ç‰‡æ°´å°</button>
                        <button class="btn" data-type="logo">Logoæ°´å°</button>
                    </div>
                </div>

                <!-- æ–‡å­—æ°´å°è®¾ç½® -->
                <div class="section" id="textSettings">
                    <div class="section-title">âœï¸ æ–‡å­—è®¾ç½®</div>
                    <div class="form-group">
                        <label class="form-label">æ°´å°æ–‡å­—</label>
                        <input type="text" class="form-input" id="watermarkText" value="æ°´å°æ–‡å­—" placeholder="è¾“å…¥æ°´å°æ–‡å­—">
                    </div>
                    <div class="grid-cols-2">
                        <div class="form-group">
                            <label class="form-label">å­—ä½“å¤§å°</label>
                            <input type="range" class="form-range" id="fontSize" min="12" max="120" value="36">
                            <div class="range-value" id="fontSizeValue">36px</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä¸é€æ˜åº¦</label>
                            <input type="range" class="form-range" id="opacity" min="0" max="100" value="70">
                            <div class="range-value" id="opacityValue">70%</div>
                        </div>
                    </div>
                    <div class="grid-cols-2">
                        <div class="form-group">
                            <label class="form-label">å­—ä½“é¢œè‰²</label>
                            <input type="color" class="color-input" id="fontColor" value="#ffffff">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å­—ä½“å®¶æ—</label>
                            <select class="form-select" id="fontFamily">
                                <option value="Arial">Arial</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Impact">Impact</option>
                                <option value="Courier New">Courier New</option>
                                <option value="å¾®è½¯é›…é»‘">å¾®è½¯é›…é»‘</option>
                                <option value="SimHei">é»‘ä½“</option>
                                <option value="SimSun">å®‹ä½“</option>
                                <option value="KaiTi">æ¥·ä½“</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- å›¾ç‰‡æ°´å°è®¾ç½® -->
                <div class="section" id="imageSettings" style="display: none;">
                    <div class="section-title">ğŸ–¼ï¸ å›¾ç‰‡æ°´å°</div>
                    <div class="image-watermark-upload" id="watermarkImageUpload">
                        <div style="font-size: 2rem; margin-bottom: 10px; color: #9ca3af;">ğŸ–¼ï¸</div>
                        <p style="font-size: 0.9rem; margin-bottom: 5px;">ç‚¹å‡»ä¸Šä¼ æ°´å°å›¾ç‰‡</p>
                        <p style="font-size: 0.8rem; color: #6b7280;">æ¨èPNGé€æ˜èƒŒæ™¯</p>
                        <input type="file" id="watermarkImageInput" accept="image/*" style="display: none;">
                    </div>
                    <img id="watermarkImagePreview" class="watermark-image-preview" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">æ°´å°å¤§å°</label>
                        <input type="range" class="form-range" id="watermarkSize" min="10" max="200" value="100">
                        <div class="range-value" id="watermarkSizeValue">100%</div>
                    </div>
                </div>

                <!-- ä½ç½®è®¾ç½® -->
                <div class="section">
                    <div class="section-title">ğŸ“ ä½ç½®è®¾ç½®</div>
                    <div class="form-group">
                        <label class="form-label">é¢„è®¾ä½ç½®</label>
                        <div class="grid-cols-3">
                            <button class="btn" data-position="top-left">å·¦ä¸Š</button>
                            <button class="btn" data-position="top-center">ä¸Šä¸­</button>
                            <button class="btn" data-position="top-right">å³ä¸Š</button>
                            <button class="btn" data-position="center-left">å·¦ä¸­</button>
                            <button class="btn active" data-position="center">å±…ä¸­</button>
                            <button class="btn" data-position="center-right">å³ä¸­</button>
                            <button class="btn" data-position="bottom-left">å·¦ä¸‹</button>
                            <button class="btn" data-position="bottom-center">ä¸‹ä¸­</button>
                            <button class="btn" data-position="bottom-right">å³ä¸‹</button>
                        </div>
                    </div>
                    <div class="grid-cols-2">
                        <div class="form-group">
                            <label class="form-label">æ°´å¹³åç§»</label>
                            <input type="range" class="form-range" id="offsetX" min="-300" max="300" value="0">
                            <div class="range-value" id="offsetXValue">0px</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å‚ç›´åç§»</label>
                            <input type="range" class="form-range" id="offsetY" min="-300" max="300" value="0">
                            <div class="range-value" id="offsetYValue">0px</div>
                        </div>
                    </div>
                    <p style="font-size: 0.8rem; color: #6b7280; margin-top: 10px;">
                        ğŸ’¡ æç¤ºï¼šå¯ç›´æ¥æ‹–æ‹½æ°´å°è°ƒæ•´ä½ç½®
                    </p>
                </div>

                <!-- æ ·å¼è®¾ç½® -->
                <div class="section">
                    <div class="section-title">ğŸ¨ æ ·å¼è®¾ç½®</div>
                    <div class="form-group">
                        <label class="form-label">æ—‹è½¬è§’åº¦</label>
                        <input type="range" class="form-range" id="rotation" min="-180" max="180" value="0">
                        <div class="range-value" id="rotationValue">0Â°</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ–‡å­—æ•ˆæœ</label>
                        <div class="button-group">
                            <button class="btn active" data-effect="none">æ— æ•ˆæœ</button>
                            <button class="btn" data-effect="shadow">é˜´å½±</button>
                            <button class="btn" data-effect="outline">æè¾¹</button>
                            <button class="btn" data-effect="glow">å‘å…‰</button>
                            <button class="btn" data-effect="emboss">æµ®é›•</button>
                            <button class="btn" data-effect="neon">éœ“è™¹</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">èƒŒæ™¯æ•ˆæœ</label>
                        <div class="button-group">
                            <button class="btn active" data-bg="none">æ— èƒŒæ™¯</button>
                            <button class="btn" data-bg="solid">å®è‰²èƒŒæ™¯</button>
                            <button class="btn" data-bg="gradient">æ¸å˜èƒŒæ™¯</button>
                            <button class="btn" data-bg="blur">æ¨¡ç³ŠèƒŒæ™¯</button>
                        </div>
                    </div>
                </div>

                <!-- é“ºæ»¡æ¨¡å¼ -->
                <div class="section">
                    <div class="section-title">ğŸ”„ é“ºæ»¡æ¨¡å¼</div>
                    <div class="form-group">
                        <div class="button-group">
                            <button class="btn active" data-tile="single">å•ä¸ªæ°´å°</button>
                            <button class="btn" data-tile="repeat">é‡å¤é“ºæ»¡</button>
                            <button class="btn" data-tile="diagonal">å¯¹è§’é“ºæ»¡</button>
                        </div>
                    </div>
                    <div class="form-group" id="tileDensityGroup" style="display: none;">
                        <label class="form-label">æ°´å°å¯†åº¦</label>
                        <input type="range" class="form-range" id="tileDensity" min="10" max="200" value="100">
                        <div class="range-value" id="tileDensityValue">100%</div>
                    </div>
                </div>
            </div>

            <div class="preview-area">
                <div class="upload-area" id="previewPlaceholder" style="width: 100%; max-width: 500px;">
                    <div style="font-size: 4rem; margin-bottom: 20px; color: #d1d5db;">ğŸ–¼ï¸</div>
                    <h3 style="margin-bottom: 10px; color: #6b7280;">å¼€å§‹ä½¿ç”¨</h3>
                    <p style="color: #9ca3af;">ä¸Šä¼ å›¾ç‰‡å¼€å§‹æ·»åŠ ä¸“ä¸šæ°´å°</p>
                </div>
                
                <div class="preview-container" id="previewContainer" style="display: none;">
                    <img id="previewImage" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">
                    <div id="watermarkContainer"></div>
                </div>

                <div class="controls" id="controls" style="display: none;">
                    <button class="control-btn primary" onclick="downloadImage()">
                        ğŸ“¥ ä¸‹è½½å›¾ç‰‡
                    </button>
                    <button class="control-btn secondary" onclick="clearImage()">
                        ğŸ”„ é‡æ–°å¼€å§‹
                    </button>
                    <button class="control-btn secondary" onclick="previewFullscreen()">
                        ğŸ” å…¨å±é¢„è§ˆ
                    </button>
                    <button class="control-btn secondary" onclick="copySettings()">
                        ğŸ“‹ å¤åˆ¶è®¾ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡å¤„ç†é¢æ¿ -->
    <div class="batch-panel" id="batchPanel">
        <div class="batch-content">
            <h2 style="margin-bottom: 20px; color: #374151;">ğŸ“¦ æ‰¹é‡å¤„ç†</h2>
            <div class="upload-area" id="batchUploadArea">
                <div style="font-size: 2.5rem; margin-bottom: 15px; color: #9ca3af;">ğŸ“</div>
                <p style="font-size: 1rem; font-weight: 500; margin-bottom: 8px;">é€‰æ‹©å¤šå¼ å›¾ç‰‡è¿›è¡Œæ‰¹é‡å¤„ç†</p>
                <p style="font-size: 0.9rem; color: #6b7280;">æ”¯æŒåŒæ—¶é€‰æ‹©å¤šä¸ªæ–‡ä»¶</p>
                <input type="file" id="batchImageInput" accept="image/*,.heic" multiple style="display: none;">
            </div>
            <div class="batch-list" id="batchList" style="display: none;">
                <!-- æ‰¹é‡æ–‡ä»¶åˆ—è¡¨ -->
            </div>
            <div class="batch-progress" id="batchProgress" style="display: none;">
                <div class="batch-progress-bar" id="batchProgressBar"></div>
            </div>
            <div class="controls" style="margin-top: 20px;">
                <button class="control-btn primary" onclick="processBatch()" id="processBatchBtn">
                    ğŸš€ å¼€å§‹å¤„ç†
                </button>
                <button class="control-btn secondary" onclick="closeBatchPanel()">
                    âŒ å…³é—­
                </button>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>
<script>
    let currentImage = null;
    let currentImageFile = null;
    let watermarkImageSrc = null;
    let batchFiles = [];
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let watermarkStartX = 0;
    let watermarkStartY = 0;
    let activeWatermark = null;

    let watermarkSettings = {
        type: 'text',
        text: 'æ°´å°æ–‡å­—',
        fontSize: 36,
        fontFamily: 'Arial',
        fontColor: '#ffffff',
        opacity: 70,
        position: 'center',
        offsetX: 0,
        offsetY: 0,
        rotation: 0,
        effect: 'none',
        bgEffect: 'none',
        tileMode: 'single',
        watermarkSize: 100,
        tileDensity: 100
    };

    // é¢„è®¾æ°´å°æ¨¡æ¿
    const watermarkPresets = {
        copyright: {
            text: 'Â© ç‰ˆæƒæ‰€æœ‰',
            fontSize: 24,
            fontFamily: 'Arial',
            fontColor: '#ffffff',
            opacity: 60,
            position: 'bottom-right',
            effect: 'shadow',
            bgEffect: 'none',
            tileMode: 'single'
        },
        confidential: {
            text: 'æœºå¯†æ–‡ä»¶',
            fontSize: 48,
            fontFamily: 'Impact',
            fontColor: '#ff0000',
            opacity: 40,
            position: 'center',
            rotation: -45,
            effect: 'outline',
            bgEffect: 'none',
            tileMode: 'diagonal'
        },
        draft: {
            text: 'DRAFT è‰ç¨¿',
            fontSize: 40,
            fontFamily: 'Arial',
            fontColor: '#888888',
            opacity: 50,
            position: 'center',
            rotation: -30,
            effect: 'outline',
            bgEffect: 'none',
            tileMode: 'repeat'
        },
        brand: {
            text: 'Your Brand Here',
            fontSize: 28,
            fontFamily: 'Georgia',
            fontColor: '#000000',
            opacity: 80,
            position: 'bottom-center',
            effect: 'glow',
            bgEffect: 'solid',
            tileMode: 'single'
        },
        photographer: {
            text: 'Photo by Photographer',
            fontSize: 20,
            fontFamily: 'Helvetica',
            fontColor: '#ffffff',
            opacity: 75,
            position: 'bottom-left',
            effect: 'shadow',
            bgEffect: 'gradient',
            tileMode: 'single'
        },
        sample: {
            text: 'SAMPLE æ ·æœ¬',
            fontSize: 36,
            fontFamily: 'Impact',
            fontColor: '#ff6b35',
            opacity: 45,
            position: 'center',
            rotation: 15,
            effect: 'neon',
            bgEffect: 'none',
            tileMode: 'repeat'
        }
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializeEventListeners();
        updateRangeValues();
        
        // æ·»åŠ å…¨å±€æ‹–æ‹½ç»“æŸç›‘å¬å™¨
        document.addEventListener('mouseup', stopDrag);
    });

    function initializeEventListeners() {
        // æ–‡ä»¶ä¸Šä¼ 
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        
        uploadArea.addEventListener('click', () => imageInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        imageInput.addEventListener('change', handleFileSelect);

        // æ‰¹é‡ä¸Šä¼ 
        const batchUploadArea = document.getElementById('batchUploadArea');
        const batchImageInput = document.getElementById('batchImageInput');
        
        batchUploadArea.addEventListener('click', () => batchImageInput.click());
        batchUploadArea.addEventListener('dragover', handleDragOver);
        batchUploadArea.addEventListener('drop', handleBatchDrop);
        batchImageInput.addEventListener('change', handleBatchFileSelect);

        // å›¾ç‰‡æ°´å°ä¸Šä¼ 
        const watermarkImageUpload = document.getElementById('watermarkImageUpload');
        const watermarkImageInput = document.getElementById('watermarkImageInput');
        
        watermarkImageUpload.addEventListener('click', () => watermarkImageInput.click());
        watermarkImageInput.addEventListener('change', handleWatermarkImageSelect);

        // é¢„è®¾æ¨¡æ¿
        document.querySelectorAll('.preset-item').forEach(item => {
            item.addEventListener('click', function() {
                const preset = this.dataset.preset;
                applyPreset(preset);
            });
        });

        // æ°´å°ç±»å‹åˆ‡æ¢
        document.querySelectorAll('[data-type]').forEach(btn => {
            btn.addEventListener('click', function() {
                switchWatermarkType(this.dataset.type);
            });
        });

        // ä½ç½®æŒ‰é’®
        document.querySelectorAll('[data-position]').forEach(btn => {
            btn.addEventListener('click', function() {
                setWatermarkPosition(this.dataset.position);
            });
        });

        // æ•ˆæœæŒ‰é’®
        document.querySelectorAll('[data-effect]').forEach(btn => {
            btn.addEventListener('click', function() {
                setTextEffect(this.dataset.effect);
            });
        });

        // èƒŒæ™¯æ•ˆæœæŒ‰é’®
        document.querySelectorAll('[data-bg]').forEach(btn => {
            btn.addEventListener('click', function() {
                setBgEffect(this.dataset.bg);
            });
        });

        // é“ºæ»¡æ¨¡å¼æŒ‰é’®
        document.querySelectorAll('[data-tile]').forEach(btn => {
            btn.addEventListener('click', function() {
                setTileMode(this.dataset.tile);
            });
        });

        // è¾“å…¥æ§ä»¶äº‹ä»¶
        document.getElementById('watermarkText').addEventListener('input', updateWatermark);
        document.getElementById('fontSize').addEventListener('input', updateWatermark);
        document.getElementById('opacity').addEventListener('input', updateWatermark);
        document.getElementById('fontColor').addEventListener('input', updateWatermark);
        document.getElementById('fontFamily').addEventListener('change', updateWatermark);
        document.getElementById('offsetX').addEventListener('input', updateWatermark);
        document.getElementById('offsetY').addEventListener('input', updateWatermark);
        document.getElementById('rotation').addEventListener('input', updateWatermark);
        document.getElementById('watermarkSize').addEventListener('input', updateWatermark);
        document.getElementById('tileDensity').addEventListener('input', updateWatermark);

        // èŒƒå›´æ»‘å—å€¼æ›´æ–°
        document.querySelectorAll('.form-range').forEach(range => {
            range.addEventListener('input', updateRangeValues);
        });
    }

    // HEIC æ–‡ä»¶å¤„ç†
    async function convertHeicToJpeg(file) {
        try {
            const convertedBlob = await heic2any({
                blob: file,
                toType: "image/jpeg",
                quality: 0.9
            });
            return new File([convertedBlob], file.name.replace(/\.heic$/i, '.jpg'), {
                type: 'image/jpeg'
            });
        } catch (error) {
            console.error('HEICè½¬æ¢å¤±è´¥:', error);
            throw new Error('HEICæ–‡ä»¶è½¬æ¢å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æ ¼å¼çš„å›¾ç‰‡');
        }
    }

    // æ–‡ä»¶æ‹–æ‹½å¤„ç†
    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
            handleFiles([files[0]]);
        }
    }

    function handleBatchDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        handleBatchFiles(files);
    }

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            handleFiles([files[0]]);
        }
    }

    function handleBatchFileSelect(e) {
        const files = Array.from(e.target.files);
        handleBatchFiles(files);
    }

    function handleWatermarkImageSelect(e) {
        const file = e.target.files[0];
        if (file) {
            loadWatermarkImage(file);
        }
    }

    // å¤„ç†å•ä¸ªæ–‡ä»¶
    async function handleFiles(files) {
        const file = files[0];
        if (!file || !file.type.startsWith('image/')) {
            if (file && file.name.toLowerCase().endsWith('.heic')) {
                try {
                    const convertedFile = await convertHeicToJpeg(file);
                    loadImage(convertedFile);
                } catch (error) {
                    alert(error.message);
                }
            } else {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
            }
            return;
        }
        loadImage(file);
    }

    // å¤„ç†æ‰¹é‡æ–‡ä»¶
    function handleBatchFiles(files) {
        const validFiles = files.filter(file => {
            return file.type.startsWith('image/') || file.name.toLowerCase().endsWith('.heic');
        });

        if (validFiles.length === 0) {
            alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
            return;
        }

        batchFiles = validFiles;
        displayBatchList();
    }

    // æ˜¾ç¤ºæ‰¹é‡æ–‡ä»¶åˆ—è¡¨
    function displayBatchList() {
        const batchList = document.getElementById('batchList');
        const batchListHtml = batchFiles.map((file, index) => `
            <div class="batch-item">
                <span style="flex: 1;">${file.name}</span>
                <span style="color: #6b7280; font-size: 0.8rem;">${formatFileSize(file.size)}</span>
                <button onclick="removeBatchFile(${index})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px 6px;">Ã—</button>
            </div>
        `).join('');
        
        batchList.innerHTML = batchListHtml;
        batchList.style.display = 'block';
        document.getElementById('processBatchBtn').disabled = false;
    }

    function removeBatchFile(index) {
        batchFiles.splice(index, 1);
        if (batchFiles.length === 0) {
            document.getElementById('batchList').style.display = 'none';
            document.getElementById('processBatchBtn').disabled = true;
        } else {
            displayBatchList();
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // åŠ è½½å›¾ç‰‡
    function loadImage(file) {
        currentImageFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            currentImage = new Image();
            currentImage.onload = function() {
                displayPreview();
                updateWatermark();
            };
            currentImage.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // åŠ è½½æ°´å°å›¾ç‰‡
    function loadWatermarkImage(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            watermarkImageSrc = e.target.result;
            const preview = document.getElementById('watermarkImagePreview');
            preview.src = watermarkImageSrc;
            preview.style.display = 'block';
            updateWatermark();
        };
        reader.readAsDataURL(file);
    }

    // æ˜¾ç¤ºé¢„è§ˆ
    function displayPreview() {
        document.getElementById('previewPlaceholder').style.display = 'none';
        document.getElementById('previewContainer').style.display = 'block';
        document.getElementById('controls').style.display = 'flex';
        
        const previewImage = document.getElementById('previewImage');
        previewImage.src = currentImage.src;
    }

    // åº”ç”¨é¢„è®¾æ¨¡æ¿
    function applyPreset(presetName) {
        // ç§»é™¤å…¶ä»–é¢„è®¾çš„activeçŠ¶æ€
        document.querySelectorAll('.preset-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // æ·»åŠ å½“å‰é¢„è®¾çš„activeçŠ¶æ€
        document.querySelector(`[data-preset="${presetName}"]`).classList.add('active');
        
        const preset = watermarkPresets[presetName];
        if (preset) {
            // æ›´æ–°è®¾ç½®
            Object.assign(watermarkSettings, preset);
            
            // æ›´æ–°UIæ§ä»¶
            document.getElementById('watermarkText').value = preset.text;
            document.getElementById('fontSize').value = preset.fontSize;
            document.getElementById('opacity').value = preset.opacity;
            document.getElementById('fontColor').value = preset.fontColor;
            document.getElementById('fontFamily').value = preset.fontFamily;
            document.getElementById('rotation').value = preset.rotation || 0;
            
            // æ›´æ–°ä½ç½®æŒ‰é’®
            document.querySelectorAll('[data-position]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.position === preset.position);
            });
            
            // æ›´æ–°æ•ˆæœæŒ‰é’®
            document.querySelectorAll('[data-effect]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.effect === preset.effect);
            });
            
            // æ›´æ–°èƒŒæ™¯æ•ˆæœæŒ‰é’®
            document.querySelectorAll('[data-bg]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.bg === preset.bgEffect);
            });
            
            // æ›´æ–°é“ºæ»¡æ¨¡å¼æŒ‰é’®
            document.querySelectorAll('[data-tile]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tile === preset.tileMode);
            });
            
            // æ›´æ–°å¯†åº¦æ»‘å—æ˜¾ç¤º
            document.getElementById('tileDensityGroup').style.display = 
                preset.tileMode !== 'single' ? 'block' : 'none';
            
            updateRangeValues();
            updateWatermark();
        }
    }

    // åˆ‡æ¢æ°´å°ç±»å‹
    function switchWatermarkType(type) {
        watermarkSettings.type = type;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('[data-type]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.type === type);
        });
        
        // æ˜¾ç¤º/éšè—å¯¹åº”è®¾ç½®é¢æ¿
        document.getElementById('textSettings').style.display = 
            type === 'text' ? 'block' : 'none';
        document.getElementById('imageSettings').style.display = 
            (type === 'image' || type === 'logo') ? 'block' : 'none';
        
        updateWatermark();
    }

    // è®¾ç½®æ°´å°ä½ç½®
    function setWatermarkPosition(position) {
        watermarkSettings.position = position;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('[data-position]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.position === position);
        });
        
        updateWatermark();
    }

    // è®¾ç½®æ–‡å­—æ•ˆæœ
    function setTextEffect(effect) {
        watermarkSettings.effect = effect;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('[data-effect]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.effect === effect);
        });
        
        updateWatermark();
    }

    // è®¾ç½®èƒŒæ™¯æ•ˆæœ
    function setBgEffect(bgEffect) {
        watermarkSettings.bgEffect = bgEffect;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('[data-bg]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.bg === bgEffect);
        });
        
        updateWatermark();
    }

    // è®¾ç½®é“ºæ»¡æ¨¡å¼
    function setTileMode(mode) {
        watermarkSettings.tileMode = mode;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('[data-tile]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tile === mode);
        });
        
        // æ˜¾ç¤º/éšè—å¯†åº¦æ»‘å—
        document.getElementById('tileDensityGroup').style.display = 
            mode !== 'single' ? 'block' : 'none';
        
        // å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨å¯¹è§’é“ºæ»¡ï¼Œè®¾ç½®è‡ªé€‚åº”è§’åº¦
        if (mode === 'diagonal' && watermarkSettings.rotation === 0) {
            const previewImage = document.getElementById('previewImage');
            if (previewImage.complete) {
                const imageRect = previewImage.getBoundingClientRect();
                const diagonalAngle = Math.atan2(imageRect.height, imageRect.width) * (180 / Math.PI);
                document.getElementById('rotation').value = Math.round(diagonalAngle);
                watermarkSettings.rotation = Math.round(diagonalAngle);
                updateRangeValues();
            }
        }
        
        updateWatermark();
    }
    
    // åœ¨å›¾ç‰‡åŠ è½½å®Œæˆæ—¶è®¾ç½®å¯¹è§’é“ºæ»¡çš„è‡ªé€‚åº”è§’åº¦
    function displayPreview() {
        document.getElementById('previewPlaceholder').style.display = 'none';
        document.getElementById('previewContainer').style.display = 'block';
        document.getElementById('controls').style.display = 'flex';
        
        const previewImage = document.getElementById('previewImage');
        previewImage.src = currentImage.src;
        
        // å¦‚æœæ˜¯å¯¹è§’é“ºæ»¡ä¸”æ²¡æœ‰è®¾ç½®æ—‹è½¬è§’åº¦ï¼Œè®¾ç½®è‡ªé€‚åº”è§’åº¦
        if (watermarkSettings.tileMode === 'diagonal' && watermarkSettings.rotation === 0) {
            previewImage.onload = function() {
                const imageRect = previewImage.getBoundingClientRect();
                const diagonalAngle = Math.atan2(imageRect.height, imageRect.width) * (180 / Math.PI);
                document.getElementById('rotation').value = Math.round(diagonalAngle);
                watermarkSettings.rotation = Math.round(diagonalAngle);
                updateRangeValues();
                updateWatermark();
            };
        }
    }

    // æ›´æ–°èŒƒå›´æ»‘å—æ˜¾ç¤ºå€¼
    function updateRangeValues() {
        const ranges = [
            { id: 'fontSize', suffix: 'px' },
            { id: 'opacity', suffix: '%' },
            { id: 'offsetX', suffix: 'px' },
            { id: 'offsetY', suffix: 'px' },
            { id: 'rotation', suffix: 'Â°' },
            { id: 'watermarkSize', suffix: '%' },
            { id: 'tileDensity', suffix: '%' }
        ];
        
        ranges.forEach(range => {
            const element = document.getElementById(range.id);
            const valueElement = document.getElementById(range.id + 'Value');
            if (element && valueElement) {
                valueElement.textContent = element.value + range.suffix;
            }
        });
    }

    // æ›´æ–°æ°´å°è®¾ç½®ï¼ˆç¡®ä¿é“ºæ»¡æ¨¡å¼ä¹Ÿå“åº”åç§»è®¾ç½®ï¼‰
    function updateWatermark() {
        if (!currentImage) return;
        
        // æ›´æ–°è®¾ç½®
        watermarkSettings.text = document.getElementById('watermarkText').value;
        watermarkSettings.fontSize = parseInt(document.getElementById('fontSize').value);
        watermarkSettings.opacity = parseInt(document.getElementById('opacity').value);
        watermarkSettings.fontColor = document.getElementById('fontColor').value;
        watermarkSettings.fontFamily = document.getElementById('fontFamily').value;
        watermarkSettings.offsetX = parseInt(document.getElementById('offsetX').value);
        watermarkSettings.offsetY = parseInt(document.getElementById('offsetY').value);
        watermarkSettings.rotation = parseInt(document.getElementById('rotation').value);
        
        if (watermarkSettings.type !== 'text') {
            watermarkSettings.watermarkSize = parseInt(document.getElementById('watermarkSize').value);
        }
        
        watermarkSettings.tileDensity = parseInt(document.getElementById('tileDensity').value);
        
        updateRangeValues();
        renderWatermark();
    }

    // æ¸²æŸ“æ°´å°
    function renderWatermark() {
        const container = document.getElementById('watermarkContainer');
        container.innerHTML = '';
        
        if (watermarkSettings.tileMode === 'single') {
            createSingleWatermark(container);
        } else {
            createTiledWatermark(container);
        }
    }

    // åˆ›å»ºå•ä¸ªæ°´å°
    function createSingleWatermark(container) {
        const watermark = createWatermarkElement();
        if (watermark) {
            positionWatermark(watermark);
            container.appendChild(watermark);
            addDragHandlers(watermark);
        }
    }

    // åˆ›å»ºå¹³é“ºæ°´å°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function createTiledWatermark(container) {
        const previewImage = document.getElementById('previewImage');
        const imageRect = previewImage.getBoundingClientRect();
        
        // è®¡ç®—æ°´å°å¤§å°ï¼ˆæ–‡å­—æ°´å°åŸºäºå­—ä½“å¤§å°ï¼Œå›¾ç‰‡æ°´å°åŸºäºè®¾ç½®å¤§å°ï¼‰
        let watermarkSize;
        if (watermarkSettings.type === 'text') {
            watermarkSize = watermarkSettings.fontSize * 2;
        } else {
            watermarkSize = 100 * (watermarkSettings.watermarkSize / 100);
        }
        
        // æ ¹æ®å¯†åº¦è®¡ç®—é—´éš”ï¼ˆå¯†åº¦è¶Šå¤§ï¼Œé—´éš”è¶Šå°ï¼‰
        const minSpacing = watermarkSize * 0.8;
        const maxSpacing = watermarkSize * 4;
        const densityFactor = (200 - watermarkSettings.tileDensity) / 100;
        const spacing = minSpacing + (maxSpacing - minSpacing) * densityFactor;
        
        // è®¡ç®—æ‰©å±•åŒºåŸŸç¡®ä¿è¦†ç›–æ•´ä¸ªå›¾ç‰‡ï¼ˆè€ƒè™‘æ—‹è½¬ï¼‰
        const extend = Math.max(imageRect.width, imageRect.height) * 0.5;
        const cols = Math.ceil((imageRect.width + extend * 2) / spacing) + 1;
        const rows = Math.ceil((imageRect.height + extend * 2) / spacing) + 1;
        
        // è®¡ç®—èµ·å§‹ä½ç½®ï¼ˆè€ƒè™‘å…¨å±€åç§»ï¼‰
        const startX = -extend + watermarkSettings.offsetX;
        const startY = -extend + watermarkSettings.offsetY;
        
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                const watermark = createWatermarkElement();
                if (watermark) {
                    let x = startX + col * spacing;
                    let y = startY + row * spacing;
                    
                    // å¯¹è§’é“ºæ»¡ç‰¹æ®Šå¤„ç†
                    if (watermarkSettings.tileMode === 'diagonal') {
                        // è®¡ç®—å¯¹è§’çº¿åç§»ï¼ˆåŸºäºå›¾ç‰‡å®½é«˜æ¯”ï¼‰
                        const diagonalOffset = (imageRect.width / imageRect.height) * (spacing / 2);
                        x += row * diagonalOffset;
                        
                        // åº”ç”¨è‡ªé€‚åº”æ—‹è½¬ï¼ˆå¦‚æœç”¨æˆ·æ²¡æœ‰è®¾ç½®è‡ªå®šä¹‰æ—‹è½¬ï¼‰
                        if (watermarkSettings.rotation === 0) {
                            const diagonalAngle = Math.atan2(imageRect.height, imageRect.width) * (180 / Math.PI);
                            watermark.style.transform = `rotate(${diagonalAngle}deg)`;
                        }
                    }
                    
                    watermark.style.left = x + 'px';
                    watermark.style.top = y + 'px';
                    
                    // åº”ç”¨ç”¨æˆ·è®¾ç½®çš„æ—‹è½¬ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (watermarkSettings.rotation !== 0) {
                        watermark.style.transform = `rotate(${watermarkSettings.rotation}deg)`;
                    }
                    
                    container.appendChild(watermark);
                }
            }
        }
    }

    // åˆ›å»ºæ°´å°å…ƒç´ 
    function createWatermarkElement() {
        let watermark;
        
        if (watermarkSettings.type === 'text') {
            watermark = document.createElement('div');
            watermark.textContent = watermarkSettings.text;
            watermark.className = 'watermark-overlay';
            
            // åŸºç¡€æ ·å¼
            watermark.style.fontSize = watermarkSettings.fontSize + 'px';
            watermark.style.fontFamily = watermarkSettings.fontFamily;
            watermark.style.color = watermarkSettings.fontColor;
            watermark.style.opacity = watermarkSettings.opacity / 100;
            watermark.style.fontWeight = 'bold';
            watermark.style.userSelect = 'none';
            watermark.style.cursor = 'move';
            
            // åº”ç”¨æ–‡å­—æ•ˆæœ
            applyTextEffect(watermark);
            
            // åº”ç”¨èƒŒæ™¯æ•ˆæœ
            applyBackgroundEffect(watermark);
            
        } else if ((watermarkSettings.type === 'image' || watermarkSettings.type === 'logo') && watermarkImageSrc) {
            watermark = document.createElement('img');
            watermark.src = watermarkImageSrc;
            watermark.className = 'watermark-overlay';
            watermark.style.opacity = watermarkSettings.opacity / 100;
            watermark.style.userSelect = 'none';
            watermark.style.cursor = 'move';
            
            // è®¾ç½®å›¾ç‰‡å¤§å°
            const scale = watermarkSettings.watermarkSize / 100;
            watermark.style.maxWidth = (100 * scale) + 'px';
            watermark.style.maxHeight = (100 * scale) + 'px';
            watermark.style.width = 'auto';
            watermark.style.height = 'auto';
        }
        
        return watermark;
    }

    // åº”ç”¨æ–‡å­—æ•ˆæœ
    function applyTextEffect(element) {
        const effect = watermarkSettings.effect;
        
        switch (effect) {
            case 'shadow':
                element.style.textShadow = '2px 2px 4px rgba(0,0,0,0.8)';
                break;
            case 'outline':
                element.style.textShadow = `
                    -1px -1px 0 #000,
                    1px -1px 0 #000,
                    -1px 1px 0 #000,
                    1px 1px 0 #000
                `;
                break;
            case 'glow':
                element.style.textShadow = `
                    0 0 5px ${watermarkSettings.fontColor},
                    0 0 10px ${watermarkSettings.fontColor},
                    0 0 15px ${watermarkSettings.fontColor}
                `;
                break;
            case 'emboss':
                element.style.textShadow = '1px 1px 0 rgba(255,255,255,0.5), -1px -1px 0 rgba(0,0,0,0.5)';
                break;
            case 'neon':
                element.style.textShadow = `
                    0 0 5px #fff,
                    0 0 10px #fff,
                    0 0 15px ${watermarkSettings.fontColor},
                    0 0 20px ${watermarkSettings.fontColor},
                    0 0 35px ${watermarkSettings.fontColor}
                `;
                break;
            default:
                element.style.textShadow = 'none';
        }
    }

    // åº”ç”¨èƒŒæ™¯æ•ˆæœ
    function applyBackgroundEffect(element) {
        const bgEffect = watermarkSettings.bgEffect;
        
        switch (bgEffect) {
            case 'solid':
                element.style.backgroundColor = 'rgba(0,0,0,0.5)';
                element.style.padding = '8px 16px';
                element.style.borderRadius = '4px';
                break;
            case 'gradient':
                element.style.background = 'linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.2))';
                element.style.padding = '8px 16px';
                element.style.borderRadius = '8px';
                break;
            case 'blur':
                element.style.backdropFilter = 'blur(10px)';
                element.style.backgroundColor = 'rgba(255,255,255,0.1)';
                element.style.padding = '8px 16px';
                element.style.borderRadius = '8px';
                element.style.border = '1px solid rgba(255,255,255,0.2)';
                break;
            default:
                element.style.backgroundColor = 'transparent';
                element.style.background = 'none';
                element.style.padding = '0';
                element.style.borderRadius = '0';
                element.style.backdropFilter = 'none';
                element.style.border = 'none';
        }
    }

    // å®šä½æ°´å°ï¼ˆè€ƒè™‘æ°´å°å°ºå¯¸ï¼‰
    function positionWatermark(watermark) {
        const previewImage = document.getElementById('previewImage');
        const imageRect = previewImage.getBoundingClientRect();
        const watermarkRect = watermark.getBoundingClientRect();
        
        // è·å–æ°´å°å®é™…å°ºå¯¸
        const watermarkWidth = watermarkRect.width;
        const watermarkHeight = watermarkRect.height;
        
        let x = 0, y = 0;
        
        // åŸºç¡€ä½ç½®è®¡ç®—ï¼ˆè€ƒè™‘æ°´å°å°ºå¯¸ï¼‰
        switch (watermarkSettings.position) {
            case 'top-left':
                x = 20;
                y = 20;
                break;
            case 'top-center':
                x = (imageRect.width - watermarkWidth) / 2;
                y = 20;
                break;
            case 'top-right':
                x = imageRect.width - watermarkWidth - 20;
                y = 20;
                break;
            case 'center-left':
                x = 20;
                y = (imageRect.height - watermarkHeight) / 2;
                break;
            case 'center':
                x = (imageRect.width - watermarkWidth) / 2;
                y = (imageRect.height - watermarkHeight) / 2;
                break;
            case 'center-right':
                x = imageRect.width - watermarkWidth - 20;
                y = (imageRect.height - watermarkHeight) / 2;
                break;
            case 'bottom-left':
                x = 20;
                y = imageRect.height - watermarkHeight - 20;
                break;
            case 'bottom-center':
                x = (imageRect.width - watermarkWidth) / 2;
                y = imageRect.height - watermarkHeight - 20;
                break;
            case 'bottom-right':
                x = imageRect.width - watermarkWidth - 20;
                y = imageRect.height - watermarkHeight - 20;
                break;
        }
        
        // æ·»åŠ åç§»é‡
        x += watermarkSettings.offsetX;
        y += watermarkSettings.offsetY;
        
        // ç¡®ä¿æ°´å°ä¸ä¼šè¶…å‡ºè¾¹ç•Œ
        x = Math.max(0, Math.min(x, imageRect.width - watermarkWidth));
        y = Math.max(0, Math.min(y, imageRect.height - watermarkHeight));
        
        watermark.style.left = x + 'px';
        watermark.style.top = y + 'px';
        watermark.style.transform = `rotate(${watermarkSettings.rotation}deg)`;
    }

    // æ·»åŠ æ‹–æ‹½å¤„ç†ç¨‹åº
    function addDragHandlers(watermark) {
        if (watermarkSettings.tileMode !== 'single') return;
        
        watermark.addEventListener('mousedown', startDrag);
        
        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            activeWatermark = watermark;
            watermark.classList.add('dragging');
            
            // è®°å½•èµ·å§‹ä½ç½®
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            
            // è®°å½•æ°´å°å½“å‰ä½ç½®
            watermarkStartX = parseFloat(watermark.style.left || 0);
            watermarkStartY = parseFloat(watermark.style.top || 0);
            
            // æ·»åŠ å…¨å±€æ‹–æ‹½ç§»åŠ¨ç›‘å¬å™¨
            document.addEventListener('mousemove', drag);
        }
    }

    // æ‹–æ‹½å¤„ç†
    function drag(e) {
        if (!isDragging || !activeWatermark) return;
        
        // è®¡ç®—ç§»åŠ¨è·ç¦»
        const deltaX = e.clientX - dragStartX;
        const deltaY = e.clientY - dragStartY;
        
        // æ›´æ–°æ°´å°ä½ç½®
        activeWatermark.style.left = (watermarkStartX + deltaX) + 'px';
        activeWatermark.style.top = (watermarkStartY + deltaY) + 'px';
    }

    // åœæ­¢æ‹–æ‹½
    function stopDrag() {
        if (!isDragging || !activeWatermark) return;
        
        isDragging = false;
        activeWatermark.classList.remove('dragging');
        
        // æ›´æ–°åç§»é‡è®¾ç½®ï¼ˆä½†ä¸æ”¹å˜é¢„è®¾ä½ç½®ï¼‰
        updateOffsetFromPosition(activeWatermark);
        
        // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
        document.removeEventListener('mousemove', drag);
        activeWatermark = null;
    }

    // æ›´æ–°åç§»é‡è®¾ç½®ï¼ˆè€ƒè™‘æ°´å°å°ºå¯¸ï¼‰
    function updateOffsetFromPosition(watermark) {
        const x = parseFloat(watermark.style.left);
        const y = parseFloat(watermark.style.top);
        
        const previewImage = document.getElementById('previewImage');
        const imageRect = previewImage.getBoundingClientRect();
        const watermarkRect = watermark.getBoundingClientRect();
        
        const watermarkWidth = watermarkRect.width;
        const watermarkHeight = watermarkRect.height;
        
        let baseX = 0, baseY = 0;
        
        // æ ¹æ®å½“å‰é¢„è®¾ä½ç½®è®¡ç®—åŸºç¡€ä½ç½®ï¼ˆè€ƒè™‘æ°´å°å°ºå¯¸ï¼‰
        switch (watermarkSettings.position) {
            case 'top-left':
                baseX = 20;
                baseY = 20;
                break;
            case 'top-center':
                baseX = (imageRect.width - watermarkWidth) / 2;
                baseY = 20;
                break;
            case 'top-right':
                baseX = imageRect.width - watermarkWidth - 20;
                baseY = 20;
                break;
            case 'center-left':
                baseX = 20;
                baseY = (imageRect.height - watermarkHeight) / 2;
                break;
            case 'center':
                baseX = (imageRect.width - watermarkWidth) / 2;
                baseY = (imageRect.height - watermarkHeight) / 2;
                break;
            case 'center-right':
                baseX = imageRect.width - watermarkWidth - 20;
                baseY = (imageRect.height - watermarkHeight) / 2;
                break;
            case 'bottom-left':
                baseX = 20;
                baseY = imageRect.height - watermarkHeight - 20;
                break;
            case 'bottom-center':
                baseX = (imageRect.width - watermarkWidth) / 2;
                baseY = imageRect.height - watermarkHeight - 20;
                break;
            case 'bottom-right':
                baseX = imageRect.width - watermarkWidth - 20;
                baseY = imageRect.height - watermarkHeight - 20;
                break;
        }
        
        // è®¡ç®—æ–°çš„åç§»é‡
        const newOffsetX = x - baseX;
        const newOffsetY = y - baseY;
        
        // æ›´æ–°UIæ§ä»¶
        document.getElementById('offsetX').value = Math.round(newOffsetX);
        document.getElementById('offsetY').value = Math.round(newOffsetY);
        
        // æ›´æ–°è®¾ç½®
        watermarkSettings.offsetX = newOffsetX;
        watermarkSettings.offsetY = newOffsetY;
        
        updateRangeValues();
    }

    // è®¾ç½®æ°´å°ä½ç½®ï¼ˆç”¨æˆ·ä¸»åŠ¨é€‰æ‹©ï¼‰
    function setWatermarkPosition(position) {
        // æ›´æ–°é¢„è®¾ä½ç½®
        watermarkSettings.position = position;
        
        // é‡ç½®åç§»é‡ä¸º0
        watermarkSettings.offsetX = 0;
        watermarkSettings.offsetY = 0;
        
        // æ›´æ–°UIæ§ä»¶
        document.getElementById('offsetX').value = 0;
        document.getElementById('offsetY').value = 0;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('[data-position]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.position === position);
        });
        
        updateRangeValues();
        updateWatermark();
    }
    
    // åˆ›å»ºæ°´å°å…ƒç´ ï¼ˆæ·»åŠ å°ºå¯¸æµ‹é‡ï¼‰
    function createWatermarkElement() {
        let watermark;
        
        if (watermarkSettings.type === 'text') {
            watermark = document.createElement('div');
            watermark.textContent = watermarkSettings.text;
            watermark.className = 'watermark-overlay';
            
            // åŸºç¡€æ ·å¼
            watermark.style.fontSize = watermarkSettings.fontSize + 'px';
            watermark.style.fontFamily = watermarkSettings.fontFamily;
            watermark.style.color = watermarkSettings.fontColor;
            watermark.style.opacity = watermarkSettings.opacity / 100;
            watermark.style.fontWeight = 'bold';
            watermark.style.userSelect = 'none';
            watermark.style.cursor = 'move';
            watermark.style.position = 'absolute';
            watermark.style.whiteSpace = 'nowrap'; // ç¡®ä¿æ–‡æœ¬ä¸æ¢è¡Œ
            
            // åº”ç”¨æ–‡å­—æ•ˆæœ
            applyTextEffect(watermark);
            
            // åº”ç”¨èƒŒæ™¯æ•ˆæœ
            applyBackgroundEffect(watermark);
            
        } else if ((watermarkSettings.type === 'image' || watermarkSettings.type === 'logo') && watermarkImageSrc) {
            watermark = document.createElement('img');
            watermark.src = watermarkImageSrc;
            watermark.className = 'watermark-overlay';
            watermark.style.opacity = watermarkSettings.opacity / 100;
            watermark.style.userSelect = 'none';
            watermark.style.cursor = 'move';
            watermark.style.position = 'absolute';
            
            // è®¾ç½®å›¾ç‰‡å¤§å°
            const scale = watermarkSettings.watermarkSize / 100;
            watermark.style.maxWidth = (100 * scale) + 'px';
            watermark.style.maxHeight = (100 * scale) + 'px';
            watermark.style.width = 'auto';
            watermark.style.height = 'auto';
        }
        
        return watermark;
    }
    
    // æ¸²æŸ“æ°´å°ï¼ˆç¡®ä¿åœ¨å®šä½å‰æ°´å°å·²æ·»åŠ åˆ°DOMï¼‰
    function renderWatermark() {
        const container = document.getElementById('watermarkContainer');
        container.innerHTML = '';
        
        if (watermarkSettings.tileMode === 'single') {
            const watermark = createWatermarkElement();
            if (watermark) {
                // å…ˆå°†æ°´å°æ·»åŠ åˆ°DOMä»¥ä¾¿æµ‹é‡å°ºå¯¸
                container.appendChild(watermark);
                
                // æ·»åŠ æ‹–æ‹½å¤„ç†ç¨‹åº
                addDragHandlers(watermark);
                
                // å®šä½æ°´å°ï¼ˆè€ƒè™‘å°ºå¯¸ï¼‰
                positionWatermark(watermark);
            }
        } else {
            createTiledWatermark(container);
        }
    }

    // ä¸‹è½½å¸¦æ°´å°çš„å›¾ç‰‡
    function downloadImage() {
        if (!currentImage) {
            alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
            return;
        }
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // è®¾ç½®ç”»å¸ƒå¤§å°
        canvas.width = currentImage.width;
        canvas.height = currentImage.height;
        
        // ç»˜åˆ¶åŸå›¾
        ctx.drawImage(currentImage, 0, 0);
        
        // ç»˜åˆ¶æ°´å°
        if (watermarkSettings.tileMode === 'single') {
            drawSingleWatermark(ctx, canvas.width, canvas.height);
        } else {
            drawTiledWatermark(ctx, canvas.width, canvas.height);
        }
        
        // ä¸‹è½½
        canvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `watermarked_${currentImageFile.name}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 'image/jpeg', 0.9);
    }

    // åœ¨ç”»å¸ƒä¸Šç»˜åˆ¶å•ä¸ªæ°´å°
    function drawSingleWatermark(ctx, canvasWidth, canvasHeight) {
        if (watermarkSettings.type === 'text') {
            drawTextWatermark(ctx, canvasWidth, canvasHeight);
        } else if (watermarkSettings.type === 'image' || watermarkSettings.type === 'logo') {
            drawImageWatermark(ctx, canvasWidth, canvasHeight);
        }
    }

    // åœ¨ç”»å¸ƒä¸Šç»˜åˆ¶å¹³é“ºæ°´å°
    function drawTiledWatermark(ctx, canvasWidth, canvasHeight) {
        let watermarkSize;
        if (watermarkSettings.type === 'text') {
            watermarkSize = watermarkSettings.fontSize * 2;
        } else {
            watermarkSize = 100 * (watermarkSettings.watermarkSize / 100);
        }
        
        // æ ¹æ®å¯†åº¦è®¡ç®—é—´éš”
        const minSpacing = watermarkSize * 0.5;
        const maxSpacing = watermarkSize * 3;
        const densityFactor = (200 - watermarkSettings.tileDensity) / 100;
        const spacing = minSpacing + (maxSpacing - minSpacing) * densityFactor;
        
        const cols = Math.ceil(canvasWidth / spacing) + 1;
        const rows = Math.ceil(canvasHeight / spacing) + 1;
        
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                let x = col * spacing;
                let y = row * spacing;
                
                if (watermarkSettings.tileMode === 'diagonal') {
                    x += (row % 2) * (spacing / 2);
                }
                
                if (watermarkSettings.type === 'text') {
                    drawTextWatermarkAt(ctx, x, y, canvasWidth, canvasHeight);
                } else if (watermarkSettings.type === 'image' || watermarkSettings.type === 'logo') {
                    drawImageWatermarkAt(ctx, x, y, canvasWidth, canvasHeight);
                }
            }
        }
    }

    // ç»˜åˆ¶æ–‡å­—æ°´å°
    function drawTextWatermark(ctx, canvasWidth, canvasHeight) {
        const { x, y } = calculateWatermarkPosition(canvasWidth, canvasHeight);
        drawTextWatermarkAt(ctx, x, y, canvasWidth, canvasHeight);
    }

    // åœ¨æŒ‡å®šä½ç½®ç»˜åˆ¶æ–‡å­—æ°´å°
    function drawTextWatermarkAt(ctx, x, y, canvasWidth, canvasHeight) {
        ctx.save();
        
        // è®¾ç½®å­—ä½“
        const fontSize = Math.floor(watermarkSettings.fontSize * (canvasWidth / 800)); // æ ¹æ®å›¾ç‰‡å¤§å°è°ƒæ•´
        ctx.font = `bold ${fontSize}px ${watermarkSettings.fontFamily}`;
        ctx.fillStyle = watermarkSettings.fontColor;
        ctx.globalAlpha = watermarkSettings.opacity / 100;
        
        // åº”ç”¨æ—‹è½¬
        ctx.translate(x, y);
        ctx.rotate((watermarkSettings.rotation * Math.PI) / 180);
        
        // åº”ç”¨æ–‡å­—æ•ˆæœ
        applyCanvasTextEffect(ctx, watermarkSettings.text, fontSize);
        
        // åº”ç”¨èƒŒæ™¯æ•ˆæœ
        if (watermarkSettings.bgEffect !== 'none') {
            applyCanvasBackgroundEffect(ctx, watermarkSettings.text, fontSize);
        }
        
        // ç»˜åˆ¶æ–‡å­—
        ctx.fillText(watermarkSettings.text, 0, 0);
        
        ctx.restore();
    }

    // ç»˜åˆ¶å›¾ç‰‡æ°´å°
    function drawImageWatermark(ctx, canvasWidth, canvasHeight) {
        if (!watermarkImageSrc) return;
        
        const img = new Image();
        img.onload = function() {
            const { x, y } = calculateWatermarkPosition(canvasWidth, canvasHeight);
            drawImageWatermarkAt(ctx, x, y, canvasWidth, canvasHeight, img);
        };
        img.src = watermarkImageSrc;
    }

    // åœ¨æŒ‡å®šä½ç½®ç»˜åˆ¶å›¾ç‰‡æ°´å°
    function drawImageWatermarkAt(ctx, x, y, canvasWidth, canvasHeight, img) {
        if (!img) return;
        
        ctx.save();
        
        const scale = (watermarkSettings.watermarkSize / 100) * (canvasWidth / 800);
        const width = img.width * scale;
        const height = img.height * scale;
        
        ctx.globalAlpha = watermarkSettings.opacity / 100;
        ctx.translate(x, y);
        ctx.rotate((watermarkSettings.rotation * Math.PI) / 180);
        
        ctx.drawImage(img, -width/2, -height/2, width, height);
        
        ctx.restore();
    }

    // è®¡ç®—æ°´å°ä½ç½®
    function calculateWatermarkPosition(canvasWidth, canvasHeight) {
        let x = 0, y = 0;
        const margin = 40; // è¾¹è·
        
        switch (watermarkSettings.position) {
            case 'top-left':
                x = margin;
                y = margin;
                break;
            case 'top-center':
                x = canvasWidth / 2;
                y = margin;
                break;
            case 'top-right':
                x = canvasWidth - margin;
                y = margin;
                break;
            case 'center-left':
                x = margin;
                y = canvasHeight / 2;
                break;
            case 'center':
                x = canvasWidth / 2;
                y = canvasHeight / 2;
                break;
            case 'center-right':
                x = canvasWidth - margin;
                y = canvasHeight / 2;
                break;
            case 'bottom-left':
                x = margin;
                y = canvasHeight - margin;
                break;
            case 'bottom-center':
                x = canvasWidth / 2;
                y = canvasHeight - margin;
                break;
            case 'bottom-right':
                x = canvasWidth - margin;
                y = canvasHeight - margin;
                break;
        }
        
        // æ·»åŠ åç§»é‡
        x += watermarkSettings.offsetX * (canvasWidth / 800);
        y += watermarkSettings.offsetY * (canvasWidth / 800);
        
        return { x, y };
    }

    // åº”ç”¨ç”»å¸ƒæ–‡å­—æ•ˆæœ
    function applyCanvasTextEffect(ctx, text, fontSize) {
        const effect = watermarkSettings.effect;
        
        switch (effect) {
            case 'shadow':
                ctx.shadowColor = 'rgba(0,0,0,0.8)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                break;
            case 'outline':
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.strokeText(text, 0, 0);
                break;
            case 'glow':
                ctx.shadowColor = watermarkSettings.fontColor;
                ctx.shadowBlur = 15;
                break;
            case 'emboss':
                // å…ˆç»˜åˆ¶é˜´å½±
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.fillText(text, 1, 1);
                // å†ç»˜åˆ¶é«˜å…‰
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.fillText(text, -1, -1);
                // é‡ç½®é¢œè‰²
                ctx.fillStyle = watermarkSettings.fontColor;
                break;
            case 'neon':
                ctx.shadowColor = watermarkSettings.fontColor;
                ctx.shadowBlur = 20;
                // å¤šæ¬¡ç»˜åˆ¶å¢å¼ºæ•ˆæœ
                for (let i = 0; i < 3; i++) {
                    ctx.fillText(text, 0, 0);
                }
                break;
        }
    }

    // åº”ç”¨ç”»å¸ƒèƒŒæ™¯æ•ˆæœ
    function applyCanvasBackgroundEffect(ctx, text, fontSize) {
        const metrics = ctx.measureText(text);
        const width = metrics.width + 32;
        const height = fontSize + 16;
        
        switch (watermarkSettings.bgEffect) {
            case 'solid':
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.fillRect(-width/2, -height/2, width, height);
                break;
            case 'gradient':
                const gradient = ctx.createLinearGradient(-width/2, -height/2, width/2, height/2);
                gradient.addColorStop(0, 'rgba(0,0,0,0.6)');
                gradient.addColorStop(1, 'rgba(0,0,0,0.2)');
                ctx.fillStyle = gradient;
                ctx.fillRect(-width/2, -height/2, width, height);
                break;
            case 'blur':
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                ctx.fillRect(-width/2, -height/2, width, height);
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.strokeRect(-width/2, -height/2, width, height);
                break;
        }
        
        // é‡ç½®å¡«å……æ ·å¼
        ctx.fillStyle = watermarkSettings.fontColor;
    }

    // æ‰¹é‡å¤„ç†å›¾ç‰‡
    async function processBatch() {
        if (batchFiles.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦å¤„ç†çš„å›¾ç‰‡');
            return;
        }
        
        const progressBar = document.getElementById('batchProgress');
        const progressBarFill = document.getElementById('batchProgressBar');
        const processBatchBtn = document.getElementById('processBatchBtn');
        
        progressBar.style.display = 'block';
        progressBarFill.style.width = '0%';
        processBatchBtn.disabled = true;
        
        const zip = new JSZip();
        let processed = 0;
        
        for (let i = 0; i < batchFiles.length; i++) {
            const file = batchFiles[i];
            
            try {
                // å¤„ç†HEICæ–‡ä»¶
                let processFile = file;
                if (file.name.toLowerCase().endsWith('.heic')) {
                    processFile = await convertHeicToJpeg(file);
                }
                
                // å¤„ç†å›¾ç‰‡
                const processedBlob = await processImageFile(processFile);
                
                // æ·»åŠ åˆ°å‹ç¼©åŒ…
                const fileName = `watermarked_${processFile.name.replace('.heic', '.jpg')}`;
                zip.file(fileName, processedBlob);
                
            } catch (error) {
                console.error(`å¤„ç†æ–‡ä»¶ ${file.name} å¤±è´¥:`, error);
                alert(`å¤„ç†æ–‡ä»¶ ${file.name} å¤±è´¥: ${error.message}`);
            } finally {
                // æ›´æ–°è¿›åº¦
                processed = i + 1;
                progressBarFill.style.width = `${(processed / batchFiles.length) * 100}%`;
            }
        }
        
        // ç”Ÿæˆå¹¶ä¸‹è½½å‹ç¼©åŒ…
        try {
            const zipBlob = await zip.generateAsync({type: 'blob'}, (metadata) => {
                progressBarFill.style.width = `${metadata.percent}%`;
            });
            
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `watermarked_images_${Date.now()}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`æ‰¹é‡å¤„ç†å®Œæˆï¼å…±å¤„ç† ${batchFiles.length} å¼ å›¾ç‰‡`);
            
        } catch (error) {
            console.error('ç”Ÿæˆå‹ç¼©åŒ…å¤±è´¥:', error);
            alert('ç”Ÿæˆå‹ç¼©åŒ…å¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            // é‡ç½®çŠ¶æ€
            setTimeout(() => {
                progressBar.style.display = 'none';
                processBatchBtn.disabled = false;
                closeBatchPanel();
            }, 1000);
        }
    }

    // å¤„ç†å•ä¸ªå›¾ç‰‡æ–‡ä»¶
    function processImageFile(file) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = img.width;
                canvas.height = img.height;
                
                // ç»˜åˆ¶åŸå›¾
                ctx.drawImage(img, 0, 0);
                
                // ç»˜åˆ¶æ°´å°
                if (watermarkSettings.tileMode === 'single') {
                    drawSingleWatermark(ctx, canvas.width, canvas.height);
                } else {
                    drawTiledWatermark(ctx, canvas.width, canvas.height);
                }
                
                canvas.toBlob(resolve, 'image/jpeg', 0.9);
            };
            img.onerror = reject;
            
            const reader = new FileReader();
            reader.onload = e => img.src = e.target.result;
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // é‡ç½®å›¾ç‰‡
    function clearImage() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰å›¾ç‰‡å—ï¼Ÿ')) {
            document.getElementById('imageInput').value = '';
            document.getElementById('previewPlaceholder').style.display = 'block';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            currentImage = null;
            currentImageFile = null;
        }
    }

    // å…¨å±é¢„è§ˆ
    function previewFullscreen() {
        if (!currentImage) {
            alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
            return;
        }
        
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.9)';
        overlay.style.zIndex = '10000';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        overlay.style.cursor = 'zoom-out';
        
        const img = new Image();
        img.src = currentImage.src;
        img.style.maxWidth = '90vw';
        img.style.maxHeight = '90vh';
        img.style.objectFit = 'contain';
        
        overlay.appendChild(img);
        document.body.appendChild(overlay);
        
        overlay.addEventListener('click', function() {
            document.body.removeChild(overlay);
        });
    }

    // æ‰“å¼€æ‰¹é‡å¤„ç†é¢æ¿
    function openBatchPanel() {
        document.getElementById('batchPanel').style.display = 'flex';
    }

    // å…³é—­æ‰¹é‡å¤„ç†é¢æ¿
    function closeBatchPanel() {
        document.getElementById('batchPanel').style.display = 'none';
    }

    // å¤åˆ¶è®¾ç½®
    function copySettings() {
        const settings = JSON.stringify(watermarkSettings, null, 2);
        navigator.clipboard.writeText(settings)
            .then(() => alert('è®¾ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
            .catch(err => console.error('å¤åˆ¶å¤±è´¥:', err));
    }

        // å…¨å±€å‡½æ•°æš´éœ²
        window.downloadImage = downloadImage;
        window.openBatchPanel = openBatchPanel;
        window.closeBatchPanel = closeBatchPanel;
        window.processBatch = processBatch;
		// window.Image = resetImage;
        window.removeBatchFile = removeBatchFile;
        // window.saveSettings = saveSettings;
        // window.loadSettings = loadSettings;
        // window.resetSettings = resetSettings;
        window.clearImage = clearImage;
        // window.clearBatchFiles = clearBatchFiles;
        // window.clearWatermarkImage = clearWatermarkImage;
        window.copySettings = copySettings;
        // window.pasteSettings = pasteSettings;
        // window.exportSettings = exportSettings;
        // window.importSettings = importSettings;
        window.removeBatchFile = removeBatchFile;
	</script>
</body>
</html>
